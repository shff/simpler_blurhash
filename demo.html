<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title></title>
  </head>
  <body>
    <script>
      // This demo requires a server. It won't work with the file:// protocol.

      function newContext(w, h) {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = w;
        canvas.height = h;

        return ctx;
      }

      function decode(data, orig_w = 500, orig_h = 300) {
        const [w, h, ...pixels] = atob(data).split("").map(a => a.charCodeAt(0));

        const context = newContext(w, h);
        const dataImage = context.createImageData(w, h);
        dataImage.data.set(pixels);
        context.putImageData(dataImage, 0, 0);

        const src = context.canvas.toDataURL("image/png");

        const img = new Image();
        img.src = src;
        img.width = orig_w;
        img.height = orig_h;
        document.body.appendChild(img);
      }

      function encode(url, w = 3, h = 3) {
        return new Promise(resolve => {
          const img = new Image();
          img.crossOrigin = "anonymous";
          img.onload = () => {
            const context = newContext(w, h);
            context.drawImage(img, 0, 0, img.width, img.height, 0, 0, w, h);
            const { data } = context.getImageData(0, 0, w, h);

            const hash = btoa(String.fromCharCode(w, h, ...data));

            resolve(hash);
          };
          img.src = url;
        });
      }

      encode(
        "https://images.unsplash.com/photo-1464821541677-ceb53bcf1541"
      ).then(hash => {
        decode(hash);
      });
    </script>
  </body>
</html>
